{
       "apiVersion": "2015-06-15",

       "type": "Microsoft.Compute/virtualMachines",

       "name": "[parameters('vmName')]",

       "location": "[resourceGroup().location]",
       "tags": {
                "displayName": "VirtualMachine"
            },
       "dependsOn": [
              "[concat('Microsoft.Storage/storageAccounts/', variables('vhdStorageName'))]",
              "[concat('Microsoft.Network/networkInterfaces/', variables('nicName'))]",
              "[concat('Microsoft.Sql/servers/', parameters('vardbserverName'))]"
            ],
       "properties": {
             "hardwareProfile": {
                    "vmSize": "[parameters('vmSize')]"
                },
                "osProfile": {
                    "computerName": "[parameters('vmName')]",
                    "adminUsername": "[parameters('adminUsername')]",
                    "adminPassword": "[parameters('adminPassword')]"
                },
        "storageProfile": {
          "osDisk": {
            "osType": "Windows",
            "name": "[concat(parameters('vmName'),'-osDisk')]",
            "createOption": "FromImage",
            "image": {
              "uri": "https://csazuredbtempl5097.blob.core.windows.net/system/Microsoft.Compute/Images/azuredbimages/otcs2-osDisk.18baa371-d960-4e8b-9272-e99f17f6ecae.vhd"
            },
            "vhd": {
               "uri": "[concat('https://csazuredbtempl5097.blob.core.windows.net/vhds/',parameters('vmName'),'osDisk.vhd')]"
            },
            "caching": "ReadWrite"
          }
        },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]"
                        }
                    ]
                },
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "enabled": true,
                        "storageUri": "[concat('http://', variables('diagnosticsStorageName'), '.blob.core.windows.net')]"
                    }
                }
            },
            "resources": [
                {
                    "type": "extensions",
                    "name": "Microsoft.Insights.VMDiagnosticsSettings",
                    "apiVersion": "2015-06-15",
                    "location": "[resourceGroup().location]",
                    "tags": {
                        "displayName": "AzureDiagnostics"
                    },
                    "dependsOn": [
                        "[concat('Microsoft.Compute/virtualMachines/', parameters('vmName'))]"
                    ],
                    "properties": {
                        "publisher": "Microsoft.Azure.Diagnostics",
                        "type": "IaaSDiagnostics",
                        "typeHandlerVersion": "1.5",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                            "xmlCfg": "[base64(concat(variables('wadcfgxstart'), variables('wadmetricsresourceid'), variables('wadcfgxend')))]",
                            "storageAccount": "[variables('diagnosticsStorageName')]"
                        },
                        "protectedSettings": {
                            "storageAccountName": "[variables('diagnosticsStorageName')]",
                            "storageAccountKey": "[listkeys(variables('accountid'), '2015-06-15').key1]",
                            "storageAccountEndPoint": "https://core.windows.net"
                        }
                    }
                },
                {
                    "name": "CreateCSscript",
                    "type": "extensions",
                    "location": "[resourceGroup().location]",
                    "apiVersion": "2015-06-15",
                    "dependsOn": [
                      "[concat('Microsoft.Compute/virtualMachines/', parameters('vmName'))]"
                    ],
                    "tags": {
                        "displayName": "CreateCSscript"
                    },
                    "properties": {
                        "publisher": "Microsoft.Compute",
                        "type": "CustomScriptExtension",
                        "typeHandlerVersion": "1.4",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                            "fileUris": ["https://raw.githubusercontent.com/nhess1981/otcs/master/CreateCSimage.ps1"],
                            "commandToExecute": "[concat('powershell -ExecutionPolicy Unrestricted -File',' CreateCSimage.ps1',' -ReplaceDBServer ', parameters('vardbserverName'), ' -ReplaceDBName ', parameters('varsqldatabaseName'), ' -ReplaceDBUser ', parameters('vardbserverAdminLogin'), ' -ReplaceDBPassword ', parameters('vardbserverAdminLoginPassword'),' -ReplaceAPassword ', parameters('CSadminPassword'))]"
                        }
                    }
                }
            ]
        }
